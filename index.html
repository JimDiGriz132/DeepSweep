<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeepSweep</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#004080">
<style>
/* ===== GLOBAL ===== */
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
  margin: 0;
  padding: 16px;
  height: auto;
  min-height: 50dvh;
  color: #333;
}

/* ===== NEW HEADER STYEL (FISHING BAR) ===== */
.topBar {
  position: relative;
  margin-bottom: 10px;
  z-index: 1000;
}

.header-main-content {
  display: flex;
  align-items: center;
  height: 56px;
  position: relative;
  overflow: visible;
  padding: 0;
}

/* ROUND MENU BUTTON */
.menu-btn {
  width: 56px;
  height: 56px;
  background: #080c0d; 
  border: 4px solid #00f2fe;
  border-radius: 50%;
  position: relative;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(0, 242, 254, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 21;
}

.menu-btn:active {
  transform: scale(0.9);
}

.reel-dots {
  width: 24px;
  height: 24px;
  border: 3px dotted #00f2fe;
  border-radius: 50%;
  opacity: 0.8;
}

.reel-dots::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 12px;
  height: 12px;
  background: #00f2fe;
  border-radius: 50%;
  box-shadow: 0 0 10px #00f2fe;
}

.reel-container {
  position: relative;
  z-index: 20; 
}

/* Line container */
.progress-container {
  flex-grow: 1;
  height: 16px; 
  background: rgba(18, 26, 29, 0.9); 
  backdrop-filter: blur(10px);
  border: 10px solid rgba(255, 255, 255, 0.1);
  border-left: none; 
  
  margin-left: -30px; 
  padding-left: 15px; 
  
  border-radius: 0 10px 10px 0;
  position: relative;
  z-index: 10;
  overflow: visible;
}

.fish-wrapper {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: left 0.4s ease-out;
    /* PROMJENA: Mora biti auto da bi hover radio */
    pointer-events: auto; 
    cursor: pointer;
    z-index: 1000;
}

.fish-icon-realistic {
  width: 24px;
  height: 24px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='white' d='M21,12C21,12 18,5 11,5C9.2,5 7.5,5.5 6.1,6.3L3.5,3.7L2.1,5.1L4.7,7.7C3.6,8.9 3,10.4 3,12C3,13.6 3.6,15.1 4.7,16.3L2.1,18.9L3.5,20.3L6.1,17.7C7.5,18.5 9.2,19 11,19C18,19 21,12 21,12M11,17C9.6,17 8.3,16.6 7.2,16L10.6,12.6C10.8,12.8 11.1,13 11.5,13C12.3,13 13,12.3 13,11.5C13,11.1 12.8,10.8 12.6,10.6L16,7.2C16.6,8.3 17,9.6 17,11C17,14.3 14.3,17 11,17Z'/%3E%3C/svg%3E");
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  z-index: 2;
  filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
}

.target-box {
  position: absolute;
  width: 44px;
  height: 24px;
  border: 2px solid #ffd700;
  border-radius: 12px;
  box-shadow: 0 0 8px #ffd700, inset 0 0 4px #ffd700;
  z-index: 1;
  animation: targetJitter 1.5s infinite ease-in-out;
}

@keyframes targetJitter {
  0% { transform: translateX(0px); }
  25% { transform: translateX(-3px) scale(1.02); } 
  50% { transform: translateX(1px); } 
  75% { transform: translateX(-2px) scale(0.98); } 
  100% { transform: translateX(0px); }
}

/* Filling line (Teal) */
.progress-fill {
  width: 0%; 
  height: 100%;
  background: linear-gradient(90deg, 
    #00f2fe 0%, 
    #71ffaf 40%, 
    #ffd700 75%, 
    #ff4b2b 100%
  );
 
  border-radius: 20px;
  box-shadow: 0 0 15px rgba(0, 242, 254, 0.5);
  transition: width 0.4s ease-out;
}

/* Fish icon */
.fish-icon {
  position: absolute;
  top: 50%;
  left: 0%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  transition: left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events: none;
  filter: drop-shadow(0 0 5px #00f2fe);
}

/* App version */
#appVersion {
  position: absolute;
  right: 15px;
  top: -18px;
  font-size: 10px;
  color: #004080;
  font-weight: bold;
  background: rgba(255,255,255,0.5);
  padding: 2px 6px;
  border-radius: 5px;
}

/* Dropdown */
.menu-dropdown {
  top: 60px;
  left: 10px;
}


/* ===== TOP BAR ===== 
.topBar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  border-radius: 10px;
  padding: 2px 16px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  position: relative;
  z-index: 1000;
}  */


/*.menu-btn {
  background: none;
  border: none;
  font-size: 1.8em;
  color: #004080;
  cursor: pointer;
  padding: 8px;
  line-height: 1;
}*/

.right-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* #installBtn {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: white;
  padding: 5px 10px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.9em;
  box-shadow: 0 2px 6px rgba(79, 172, 254, 0.3);
  transition: all 0.2s; 
  cursor: pointer;
  white-space: nowrap;
  border: none;
  outline: none;
  display: flex;
  align-items: center; 
  justify-content: center;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  min-height: 20px;
  line-height: 1;
}
*/

/*#appVersion {
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: white;
  padding: 5px 5px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.6em;
  box-shadow: 0 2px 6px rgba(79, 172, 254, 0.3);
  transition: all 0.2s;
  cursor: pointer;
  white-space: nowrap;
  border: none;
  outline: none;
  display: inline-flex;
  align-items: center; 
  justify-content: center;
  line-height: 1;
}*/

/*#installBtn:hover {
    transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
}
*/
#appVersion:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
}
/* Dropdown */
.menu-dropdown {
  position: absolute;
  top: 100%;
  left: 16px;     
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  border-radius: 10px;
  padding: 12px 0;
  min-width: 220px;
  z-index: 10000;
  margin-top: 4px;
  display: none;
}

.menu-dropdown ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.menu-dropdown li {
  list-style: none;
  margin: 6px 12px;
  padding: 0;
}

.menu-dropdown a {
  text-decoration: none;
  color: #333;
  display: block;
}*/

/*.menu-dropdown a:hover {
  background: #f0f4ff;
}
*/
/* Button and links inside menu dropdown */
.menu-dropdown a,
.menu-dropdown a:hover,
.menu-dropdown a:focus,
.menu-dropdown a:visited {
  color: white !important;
  text-decoration: none !important;
  
}
.menu-item-btn {
  display: block !important; 
  width: 100%;
  margin: 0;
  padding: 5px 0px;
  gap: 10px; 
  justify-content: flex-start;
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: white !important; 
  font-weight: bold;
  font-size: 1em;
  text-align: center; 
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
  
  border: none;
  outline: none;
  cursor: pointer;
  
  transition: all 0.25s ease;
  
  /* Reset */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

/* Hover */
.menu-item-btn:hover {
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.55);
  background: linear-gradient(90deg, #3a8eff, #00cfff);
}

/* Active */
.menu-item-btn:active {
  transform: translateY(0) scale(0.98);
}

.menu-dropdown li {
padding: 0 12px;
  margin: 4px 0;
  width: 100%;
  box-sizing: border-box;

}
/* Popup style */
.fish-popup {
  position: absolute;
  bottom: 40px; /* Pozicija iznad ribe */
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: #ffd700; /* Å½uta boja kao meta */
  color: #000;
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 13px;
  white-space: nowrap;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none; /* Da ne "hvata" klikove */
  z-index: 200;
}

.fish-popup::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: #ffd700 transparent transparent transparent;
}

/* Hover (PC) & active class (Mobile) */
.fish-wrapper:hover .fish-popup {
    opacity: 1 !important;
    transform: translateX(-50%) translateY(0) !important;
}
.fish-wrapper.active .fish-popup {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* ===== COUNTER ===== */
#counter {
  text-align: center;
  font-size: 1.3em;
  color: #004080;
  font-weight: 600;
  margin: 20px auto;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  max-width: 320px;
  width: 90%;
}

/* ===== LIST â€“ reset default browser style ===== */
#container,
#container ul,
#container li {
  padding: 0;
  list-style: none;
}

/* ===== FLOORS, GROUPS, ITEMS ===== */
.floor, .group > div, .item {
  background: white;
  border-radius: 16px;
  margin: 10px 0;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  
}

 .group > div:hover, .item:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

/* Floor */
.floor {
  font-weight: bold;
  font-size: 1.3em;
  padding: 0;

  background: linear-gradient(90deg, #b3d9ff, #d0e7f9);
}

.floor > div {
  padding: 10px 10px;
}

/* Group */
.group {
  margin: 8px 0 8px 20px;
  width: calc(100% - 40px);
}

/* Group wrapper */
.group > div {
  background: #f8fbff;
  border-radius: 12px;
  padding: 10px 14px;
  margin: 6px 0;
  margin-left: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Item */
.item {
  margin: 6px 0 6px 40px;
  padding: 0;
}

/* Item wrapper */
.item > div {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px 16px;
  width: calc(100% - 40px);
  margin-left: 5px;
  padding: 6px 4px 6px 4px;
}

/* 1st row: checkbox + pic */
.item .first-row {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

/* Name */
.item label {
  flex: 1;
  min-width: 0;
  font-weight: 600;
  font-size: 1.05em;
  color: #222;
  line-height: 1.35;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: normal;
}

/* Location btn  */
a.locationBtn {
  background: linear-gradient(90deg, #667eea, #764ba2);
  color: white;
  border-radius: 12px;
  padding: 8px 16px;
  font-weight: 600;
  box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
  transition: all 0.2s;
  white-space: nowrap;
  text-align: center;
  min-width: 140px;
  flex-shrink: 0;
  margin-left: auto;
}

/* Phone */
@media (max-width: 640px) {
  .item > div {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
	justify-content: center; 
    min-height: 100px;
	padding: 6px 4px 6px 4px;
  }

  .item label {
    margin-left: 32px;
    width: 100%;
    flex: none;
  }
  .item .first-row {
    align-self: left;
  }
  
  a.locationBtn {
    font-weight: 400;
	text-align: center;
    margin-left: 0;
    align-self: flex-start;
	margin-left: 32px;
    width: 170px;

	box-sizing: border-box;
	white-space: nowrap;
  }
}

/* ===== Item pics ===== */
.item img,
.item .first-row img {
  height: 40px; 
  width: auto;
  object-fit: contain;

}

/* Tooltip */
.version-tooltip {
  position: fixed;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 16px 20px; 
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
  z-index: 9999;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  max-width: 320px;
  pointer-events: auto;
  box-sizing: border-box;
}
.version-tooltip ul {
  padding-left: 2px;
  margin: 10px 0 0 0;
  list-style-position: inside;
}

.version-tooltip li {
  margin-bottom: 6px;
}



/* Logo */
.app-logo {
  max-width: 280px;
  width: 85%;
  height: auto;
  display: block;
  margin: 0 auto;
  filter: drop-shadow(0 6px 16px rgba(0,0,0,0.15));
}

/* Broom animation */
.broom-anim {
  position: absolute;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  font-size: 24px;
  pointer-events: none;
  z-index: 10;
  animation: broomSweep 0.8s ease-out forwards;
}

@keyframes broomSweep {
  0% {
    transform: translateY(-50%) translateX(0) rotate(-15deg);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-50%) translateX(var(--broom-end)) rotate(10deg);
    opacity: 0;
  }
}

.toggle {
  cursor: pointer;    
  user-select: none;   
  padding: 4px 8px;  
  border-radius: 4px;
  transition: all 0.15s;
}

.toggle:hover {
  background: rgba(0, 100, 200, 0.15);
  color: #0066cc;
}

.toggle.active {
  color: #004080;
  font-weight: bold;
}

</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topBar">
  <div class="header-main-content">
    <div class="reel-container">
      <button id="menuBtn" class="menu-btn">
        <div class="reel-dots"></div>
      </button>
    </div>

    <div class="progress-container">
      <div id="progressBarFill" class="progress-fill"></div>
      
      <div id="fishWrapper" class="fish-wrapper">
        <div id="fishCounterPopup" class="fish-popup">0 / 0</div>
        <div class="target-box"></div>
        <div class="fish-icon-realistic"></div>
      </div>
    </div>
  </div>

  <div id="appVersion">v<span id="versionNum"></span></div>

  <div id="menuDropdown" class="menu-dropdown">
    <ul>
      <li><button id="installBtn" class="menu-item-btn">Install</button></li>
      <li><a href="https://cloversalad.com/" class="menu-item-btn" target="_blank">CloverSalad</a></li>
      <li><a href="https://fish-metrics.com/" class="menu-item-btn" target="_blank">FishMetrics</a></li>
	  <li><a href="https://discord.com/invite/Dp3tk2aQqb" class="menu-item-btn" target="_blank">Carp Diem Discord</a></li>
    </ul>
  </div>
</div>


<div id="installAlert" class="version-tooltip" style="display:none">
  <p><strong>To install DeepSweep:</strong></p>
  <ul><strong>Android:</strong> Open browser menu â†’ Add to Home screen</ul>
  <ul><strong>iOS:</strong> Tap Share â†’ Add to Home Screen</ul>
</div>
<div id="versionTooltip" class="version-tooltip" style="display:none">
  <strong>What's new</strong>
  <ul id="changesList"></ul>
</div>

<div class="app-title">
  <img src="logo.png" alt="DeepSweep" class="app-logo">
</div>
<!--<p id="counter">Total Trash: 0 | Found: 0</p> -->

<!-- Find Unfound + Location Filter -->
<button id="openUncheckedBtn">Missing Items</button>
<select id="locationFilter">
  <option value="-all-">-all-</option>
</select>

<ul id="container"></ul>

<script>
// Menu toggle
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');

menuBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  menuDropdown.style.display = menuDropdown.style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click', (e) => {
  if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
    menuDropdown.style.display = 'none';
  }
});


// --- INSTALL BUTTON + ALERT ---

const installAlert = document.getElementById('installAlert');
let installTooltipVisible = false;

// --- PWA install logic ---
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
function hideInstall() {
  const installLi = installBtn.closest('li');
  if (installLi) installLi.style.display = 'none';
  installAlert.style.display = 'none';
}

function showInstall() {
  const installLi = installBtn.closest('li');
  if (installLi) installLi.style.display = '';
}

// Check if app is installed
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
  hideInstall();
} else {
  showInstall(); 
}

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstall();
});
installBtn.addEventListener('touchend', (e) => {
  e.preventDefault();
});


function showInstallTooltip() {
  if (installAlert.style.display === 'block') return;

  installAlert.style.display = 'block';
  installAlert.style.opacity = '0';
  installAlert.style.transform = 'translateY(-6px)';

  const rect = installBtn.getBoundingClientRect();
  
  installAlert.style.top = (rect.bottom + window.scrollY + 8) + 'px';

  let left = rect.left + window.scrollX;
  const padding = 12;
  const tooltipWidth = installAlert.offsetWidth;

  if (left + tooltipWidth > window.innerWidth - padding) {
    left = window.innerWidth - tooltipWidth - padding;
  }
  if (left < padding) {
    left = padding;
  }

  installAlert.style.left = left + 'px';
  installAlert.style.right = 'auto';

  requestAnimationFrame(() => {
    installAlert.style.opacity = '1';
    installAlert.style.transform = 'translateY(0)';
  });

  installTooltipVisible = true;
}

function hideInstallTooltip() {
  if (!installTooltipVisible) return;
  installAlert.style.opacity = '0';
  installAlert.style.transform = 'translateY(-6px)';
  setTimeout(() => {
    installAlert.style.display = 'none';
    installTooltipVisible = false;
  }, 180);
}

function toggleInstallTooltip(e) {
  e.preventDefault();
  e.stopPropagation();

  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(({ outcome }) => {
      deferredPrompt = null;
      if (outcome === 'accepted') {
        hideInstall();
      }
      hideInstallTooltip();
    });
    return;
  }

  if (installTooltipVisible) {
    hideInstallTooltip();
  } else {
    showInstallTooltip();
  }
}

const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

if (isTouch) {
  installBtn.addEventListener('touchend', toggleInstallTooltip);
} else {
  installBtn.addEventListener('click', toggleInstallTooltip);
}

function closeIfOutside(e) {
  if (!installTooltipVisible) return;
  if (installBtn.contains(e.target) || installAlert.contains(e.target)) return;
  hideInstallTooltip();
}

document.addEventListener(isTouch ? 'touchend' : 'click', closeIfOutside);

installAlert.addEventListener(isTouch ? 'touchend' : 'click', e => e.stopPropagation());

document.addEventListener('click', (e) => {
  if (installAlert.style.display === 'block' &&
      !installBtn.contains(e.target) &&
      !installAlert.contains(e.target)) {
    installAlert.style.display = 'none';
  }
});
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
    .then(reg => {
      console.log('Service Worker registered');
      console.log('Scope:', reg.scope);          // vidiÅ¡ toÄno Å¡to je postavljeno
    })
    .catch(err => console.log('SW registration failed', err));
}

// --- LocalStorage helpers ---
function loadState(){ return JSON.parse(localStorage.getItem('deepsweepState')||'{}'); }
function saveState(state){ localStorage.setItem('deepsweepState', JSON.stringify(state)); }

// --- Counter ---
function updateCounter() {
    // TraÅ¾imo sve checkboxove unutar elemenata s klasom 'item'
    const checkboxes = document.querySelectorAll('.item input[type="checkbox"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
    const total = checkboxes.length;

    console.log("Checkboxovi pronaÄ‘eni:", total, "OznaÄeno:", checked); // Za testiranje

    // 1. AÅ¾uriranje skoÄnog prozorÄiÄ‡a iznad ribe
    const fishPopup = document.getElementById('fishCounterPopup');
    if (fishPopup) {
        fishPopup.textContent = `${checked} / ${total}`;
    }

    // 2. AÅ¾uriranje glavnog tekstualnog brojaÄa (ako ga imaÅ¡)
    const counterDisplay = document.getElementById('counter');
    if (counterDisplay) {
        counterDisplay.textContent = `Total Trash: ${total} | Found: ${checked}`;
    }

    // 3. Pomicanje ribe i punjenje trake
    const percentage = total > 0 ? (checked / total) * 100 : 0;
    const fill = document.getElementById('progressBarFill');
    const fishWrapper = document.getElementById('fishWrapper');

    if (fill) fill.style.width = percentage + '%';
    if (fishWrapper) fishWrapper.style.left = percentage + '%';
}

// VAÅ½NO: Pozovi funkciju jednom odmah pri uÄitavanju da ne stoji 0/0
window.onload = updateCounter;

// 2. Dodatak za mobitele: Klik na ribu pali prozorÄiÄ‡ na 3 sekunde
const fishContainer = document.getElementById('fishWrapper');
if (fishContainer) {
  fishContainer.addEventListener('click', function() {
    this.classList.add('active');
    
    // Automatski sakrij nakon 3 sekunde
    clearTimeout(this.hideTimeout);
    this.hideTimeout = setTimeout(() => {
      this.classList.remove('active');
    }, 3000);
  });
}

// --- Load JSON and build UI ---
let state = loadState();

fetch('/data.json')
  .then(res => res.json())
  .then(data => {
    buildUI(data);
    syncGroupAndFloorCheckboxes();
    updateCounter();

    // Manual order
    const desiredOrder = [
      "-all-",
      "Paradise Island",
      "Great Lakes",
      "Costa Rica",
      "Alaska",
      "Australia",
      "Scotland",
      "Thailand",
      "Amazon",
	  "Marina",
	  "Chemical Plant"
    ];

    const locationFilter = document.getElementById('locationFilter');
    locationFilter.innerHTML = ''; // oÄisti stare opcije

    const existingLocations = new Set(
      data.map(item => item.locationName).filter(Boolean)
    );

    desiredOrder.forEach(loc => {
      if (loc === "-all-" || existingLocations.has(loc)) {
        const opt = document.createElement('option');
        opt.value = loc;
        opt.textContent = loc;
        locationFilter.appendChild(opt);
      }
    });
  })
  .catch(err => {
    console.error("Failed to load data.json", err);
  });
  
  
    // --- Populate Location Dropdown ---
   //const locationFilter = document.getElementById('locationFilter');
    //const locationsSet = new Set();
    //data.forEach(item=>{ if(item.locationName) locationsSet.add(item.locationName); });
    //locationsSet.forEach(loc=>{
      //const opt = document.createElement('option');
      //opt.value = loc;
      //opt.textContent = loc;
      //locationFilter.appendChild(opt);
   //});



function buildUI(data){
  const floors = {};
  data.forEach(item=>{
    if(!floors[item.floor]) floors[item.floor]={};
    if(!floors[item.floor][item.group]) floors[item.floor][item.group]=[];
    floors[item.floor][item.group].push(item);
  });

  const container = document.getElementById('container');

  function createItem(item, groupCheckbox, floorCheckbox){
  const li = document.createElement('li'); 
  li.className = 'item';

  const wrapper = document.createElement('div');

  const id = `${item.floor}_${item.group}_${item.name}`.replace(/\s/g,'_');

  const cb = document.createElement('input'); 
  cb.type = 'checkbox'; 
  cb.id = id; 
  cb.dataset.id = id;
  if(state[id]!==undefined) cb.checked = state[id];

  cb.addEventListener('change', ()=>{
    if (navigator.vibrate) navigator.vibrate(15);
    state[id] = cb.checked;
    updateGroupAndFloor(groupCheckbox, floorCheckbox);
    saveState(state);
    updateCounter();
  });

  const img = document.createElement('img'); 
  img.src = item.img; 
  img.alt = item.name;
  img.addEventListener('click', ()=>{ 
    cb.checked = !cb.checked; 
    cb.dispatchEvent(new Event('change')); 
  });

  const label = document.createElement('label'); 
  label.setAttribute('for', id); 
  label.textContent = item.name;
  label.title = item.name; // za tooltip na mobitelu

  // Novi div za prvi red: checkbox + slika
  const firstRow = document.createElement('div');
  firstRow.className = 'first-row';
  firstRow.appendChild(cb);
  firstRow.appendChild(img);

  wrapper.appendChild(firstRow);
  wrapper.appendChild(label);

  if(item.locationName && item.locationLink){
    const locBtn = document.createElement('a');
    locBtn.textContent = item.locationName;
    locBtn.href = item.locationLink;
    locBtn.target = '_blank';
    locBtn.className = 'locationBtn';
    wrapper.appendChild(locBtn);
  }

  li.appendChild(wrapper);
  return li;
}

  function createGroup(groupName, items, floorCheckbox){
    const li=document.createElement('li'); li.className='group';
    const wrapper=document.createElement('div');
    const toggle=document.createElement('span'); toggle.textContent='â–¶'; toggle.className='toggle';
    const id=`group_${groupName}`.replace(/\s/g,'_');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.id=id;
    if(state[id]!==undefined) cb.checked=state[id];

    cb.addEventListener('change', ()=>{
        const checked = cb.checked;
        li.querySelectorAll('li.item input[type=checkbox]').forEach(i=>{
            i.checked = checked;
            if(i.dataset.id) state[i.dataset.id] = i.checked;
        });
        state[id] = checked;
        saveState(state);
        updateGroupAndFloor(cb, floorCheckbox);
        updateCounter();
    });

    const label=document.createElement('span'); label.textContent=groupName;
    const itemsList=document.createElement('ul');
    items.forEach(item=>itemsList.appendChild(createItem(item, cb, floorCheckbox)));
    itemsList.style.display='none';

	toggle.addEventListener('click', () => {
    itemsList.style.display = itemsList.style.display === 'none' ? 'block' : 'none';
    toggle.textContent = itemsList.style.display === 'none' ? 'â–¶' : 'â–¼';
    
    // opcionalno: dodaj klasu za hover stilove
    toggle.classList.toggle('active', itemsList.style.display !== 'none');
});
    label.addEventListener('click', ()=>toggle.click());

    wrapper.appendChild(toggle); wrapper.appendChild(cb); wrapper.appendChild(label);
    li.appendChild(wrapper);
    li.appendChild(itemsList);
    return li;
  }

  function createFloor(floorName, groups){
    const li=document.createElement('li'); li.className='floor';
    const wrapper=document.createElement('div');
    const toggle=document.createElement('span'); toggle.textContent='â–¶'; toggle.className='toggle';
    const id=`floor_${floorName}`.replace(/\s/g,'_');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.id=id;
    if(state[id]!==undefined) cb.checked=state[id];

    cb.addEventListener('change', ()=>{
        const checked = cb.checked;
        li.querySelectorAll('li.group > div > input[type=checkbox], li.item input[type=checkbox]').forEach(i=>{
            i.checked = checked;
            if(i.dataset.id) state[i.dataset.id] = i.checked;
        });
        state[id] = checked;
        saveState(state);
        updateCounter();
    });

    const label=document.createElement('span'); label.textContent=floorName;
    const groupsList=document.createElement('ul');
    for(const groupName in groups) groupsList.appendChild(createGroup(groupName, groups[groupName], cb));
    groupsList.style.display='none';

    toggle.addEventListener('click', ()=>{ 
        groupsList.style.display = groupsList.style.display==='none'?'block':'none'; 
        toggle.textContent = groupsList.style.display==='none'?'â–¶':'â–¼'; 
    });
    label.addEventListener('click', ()=>toggle.click());

    wrapper.appendChild(toggle); wrapper.appendChild(cb); wrapper.appendChild(label);
    li.appendChild(wrapper);
    li.appendChild(groupsList);
    container.appendChild(li);
  }

  for(const floorName in floors) createFloor(floorName,floors[floorName]);

  function updateGroupAndFloor(groupCheckbox, floorCheckbox){
  const groupLi = groupCheckbox.closest('li.group');
  const items = groupLi.querySelectorAll('li.item input[type=checkbox]');
  const allChecked = Array.from(items).every(i=>i.checked);

  groupCheckbox.checked = allChecked;

if (allChecked) {
  // group animation
  playBroomAnimation(groupLi);

  // haptic feedback
  if (navigator.vibrate) {
    navigator.vibrate([20, 30, 20]);
  }
}
function playBroomAnimation(groupLi) {
  const wrapper = groupLi.querySelector('div');
  const checkbox = wrapper.querySelector('input[type="checkbox"]');
  const label = wrapper.querySelector('span');

  if (!wrapper || !checkbox || !label) return;

  const broom = document.createElement('span');
  broom.textContent = 'ðŸ§¹';
  broom.className = 'broom-anim';

  wrapper.style.position = 'relative';
  wrapper.appendChild(broom);

  // group start = checkbox
  const startX = checkbox.offsetLeft;
  const endX = label.offsetLeft + label.offsetWidth;

  broom.style.left = startX + 'px';
  broom.style.setProperty('--broom-end', endX + 'px');

  broom.addEventListener('animationend', () => {
    broom.remove();
  });
}

  // floor logic
  const groups = floorCheckbox
    .closest('li.floor')
    .querySelectorAll('li.group > div > input[type=checkbox]');

  floorCheckbox.checked = Array.from(groups).every(g=>g.checked);
}
}
function syncGroupAndFloorCheckboxes() {
  // GROUPS
  document.querySelectorAll('li.group').forEach(groupLi => {
    const groupCheckbox = groupLi.querySelector('div > input[type=checkbox]');
    const items = groupLi.querySelectorAll('li.item input[type=checkbox]');
    if (!groupCheckbox || items.length === 0) return;

    groupCheckbox.checked = Array.from(items).every(cb => cb.checked);
  });

  // FLOORS
  document.querySelectorAll('li.floor').forEach(floorLi => {
    const floorCheckbox = floorLi.querySelector('div > input[type=checkbox]');
    const groupCheckboxes = floorLi.querySelectorAll('li.group > div > input[type=checkbox]');
    if (!floorCheckbox || groupCheckboxes.length === 0) return;

    floorCheckbox.checked = Array.from(groupCheckboxes).every(cb => cb.checked);
  });
}

// --- Find Unfound with Location Filter (Toggle Behavior) ---
let missingOpen = false; // prati je li trenutno otvoreno
function runMissingItemsFilter() {
  const filter = document.getElementById('locationFilter').value;

  if (missingOpen) {
    document.querySelectorAll('li.floor').forEach(floorLi => {
      const groupsList = floorLi.querySelector('ul');
      if (groupsList) groupsList.style.display = 'none';

      const floorToggle = floorLi.querySelector('.toggle');
      if (floorToggle) floorToggle.textContent = 'â–¶';

      floorLi.querySelectorAll('li.group').forEach(groupLi => {
        const ul = groupLi.querySelector('ul');
        const toggle = groupLi.querySelector('.toggle');
        if (ul) ul.style.display = 'none';
        if (toggle) toggle.textContent = 'â–¶';

        groupLi.querySelectorAll('li.item').forEach(itemLi => {
          itemLi.style.display = '';
        });
      });
    });

    missingOpen = false;
    return;
  }

  document.querySelectorAll('li.floor').forEach(floorLi => {
    let floorHasUnchecked = false;

    floorLi.querySelectorAll('li.group').forEach(groupLi => {
      let groupHasUnchecked = false;

      groupLi.querySelectorAll('li.item').forEach(itemLi => {
        const cb = itemLi.querySelector('input[type=checkbox]');
        const locBtn = itemLi.querySelector('.locationBtn');
        const locName = locBtn ? locBtn.textContent : null;

        const matchesLocation =
          filter === '-all-' || filter === locName;

        if (!matchesLocation || cb.checked) {
          itemLi.style.display = 'none';
          return;
        }

        itemLi.style.display = '';
        groupHasUnchecked = true;
      });

      const ul = groupLi.querySelector('ul');
      const toggle = groupLi.querySelector('.toggle');

      if (groupHasUnchecked) {
        ul.style.display = 'block';
        toggle.textContent = 'â–¼';
        floorHasUnchecked = true;
      } else {
        ul.style.display = 'none';
        toggle.textContent = 'â–¶';
      }
    });

    const floorUl = floorLi.querySelector('ul');
    const floorToggle = floorLi.querySelector('.toggle');

    if (floorHasUnchecked) {
      floorUl.style.display = 'block';
      floorToggle.textContent = 'â–¼';
    } else {
      floorUl.style.display = 'none';
      floorToggle.textContent = 'â–¶';
    }
  });

  missingOpen = true;
}

function refreshMissingItemsFilter() {
  if (!missingOpen) return;

  // privremeno ugasi flag
  missingOpen = false;
  runMissingItemsFilter();
}

document
  .getElementById('openUncheckedBtn')
  .addEventListener('click', runMissingItemsFilter);

document
  .getElementById('locationFilter')
  .addEventListener('change', refreshMissingItemsFilter);



// ================= VERSION BADGE TOOLTIP =================
fetch('/version.json')
  .then(res => res.json())
  .then(v => {
    const badge = document.getElementById('appVersion');
    if (!badge) return;

    const currentVersion = v.current;
    const changes = v.changes?.[currentVersion] || [];

    badge.textContent = 'v' + currentVersion;

    // red dot
    if (localStorage.getItem('deepsweep_seenVersion') !== currentVersion) {
      const dot = document.createElement('span');
      Object.assign(dot.style, {
        display: 'inline-block',
        width: '8px',
        height: '8px',
        background: 'red',
        borderRadius: '50%',
        marginLeft: '6px',
        verticalAlign: 'middle'
      });
      badge.appendChild(dot);
    }

    let tooltip = null;

    const closeTooltip = () => {
      if (!tooltip) return;
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(-6px)';
      setTimeout(() => {
        tooltip?.remove();
        tooltip = null;
      }, 160);
    };

    const toggleTooltip = (e) => {
      e.stopPropagation();
      if (!changes.length) return;

      if (tooltip) {
        closeTooltip();
        return;
      }

      tooltip = document.createElement('div');
      tooltip.className = 'version-tooltip';
      tooltip.innerHTML = `
        <strong>What's new</strong>
        <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
      `;

      document.body.appendChild(tooltip);

      const rect = badge.getBoundingClientRect();
	  tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';

      let left = rect.left + window.scrollX;
      const tooltipWidth = tooltip.offsetWidth;
const badgeRight = rect.right + window.scrollX;
if (left + tooltipWidth > badgeRight) {
  left = badgeRight - tooltipWidth;  // desna strana tooltipa = desna strana badgea
}

if (left < 8) left = 8;
if (left + tooltipWidth > window.innerWidth - 8) {
  left = window.innerWidth - tooltipWidth - 8;
}

tooltip.style.left = left + 'px';

      requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'translateY(0)';
      });

      localStorage.setItem('deepsweep_seenVersion', currentVersion);
      badge.querySelector('span')?.remove();
    };

badge.addEventListener('click', toggleTooltip);

if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
  badge.addEventListener('touchend', (e) => {
    e.preventDefault();
    toggleTooltip(e);
  });
}

    document.addEventListener('click', (e) => {
      if (tooltip && !badge.contains(e.target) && !tooltip.contains(e.target)) {
        closeTooltip();
      }
    });
  })
  .catch(err => console.error('Failed to load version.json', err));


</script>
</body>
</html>
