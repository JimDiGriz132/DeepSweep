<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeepSweep</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#004080">
<style>
/* ===== GLOBAL ===== */
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
  margin: 0;
  padding: 16px;
  min-height: 100vh;
  color: #333;
}

/* ===== TOP BAR ===== */
.topBar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 6px 6px;
  border-radius: 16px;
  margin-bottom: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

#installBtn {
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
  transition: all 0.2s;
}

#installBtn:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
}

#appVersion {
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: #333;
  padding: 6px 14px;
  border-radius: 12px;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

#appVersion:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
}

/* ===== COUNTER ===== */
#counter {
  text-align: center;
  font-size: 1.3em;
  color: #004080;
  font-weight: 600;
  margin: 20px auto;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  max-width: 320px;
  width: 90%;
}

/* ===== LIST ===== */
#container,
#container ul,
#container li {
  margin: 0;
  padding: 0;
  list-style: none;
}

/* ===== FLOORS, GROUPS, ITEMS ===== */
.floor, .group > div, .item {
  background: white;
  border-radius: 16px;
  margin: 12px 0;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.floor:hover, .group > div:hover, .item:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
}

/* Floor â€“ puna Å¡irina, bez margina */
.floor {
  font-weight: bold;
  font-size: 1.3em;
  padding: 0;
  background: linear-gradient(90deg, #b3d9ff, #d0e7f9);
}

.floor > div {
  padding: 12px 16px;
}

/* Grupa â€“ pomaknuta 20px desno unutar floor-a */
.group {
  margin: 8px 0 8px 20px;
  width: calc(100% - 40px);
}

/* Grupa wrapper */
.group > div {
  background: #f8fbff;
  border-radius: 12px;
  padding: 10px 14px;
  margin: 6px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Item â€“ pomaknut dodatno 20px desno unutar grupe */
.item {
  margin: 6px 0 6px 20px;
  padding: 0;
}

/* Item wrapper */
.item > div {
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Prvi red: checkbox + slika */
.item .first-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.item input[type="checkbox"] {
  width: 24px;
  height: 24px;
  margin: 0;
  accent-color: #4facfe;
  cursor: pointer;
}

.item img {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  cursor: pointer;
}

/* Naziv */
.item label {
  font-weight: 600;
  font-size: 1.0em;
  color: #222;
  line-height: 1.35;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: normal;
}

/* Location  */
a.locationBtn {
  background: linear-gradient(90deg, #667eea, #764ba2);
  color: white;
  border-radius: 12px;
  padding: 8px 16px;
  font-weight: 600;
  font-size: 1.0em;
  box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
  transition: all 0.2s;
  align-self: flex-start;
  text-align: center;
}

a.locationBtn:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

/* Dropdown */
#locationFilter {
  padding: 10px 14px;
  font-size: 1em;
  border-radius: 12px;
  border: 1px solid #ccc;
  background: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Tooltip */
.version-tooltip {
  position: fixed;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 14px 18px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
  z-index: 9999;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  max-width: 320px;
  pointer-events: auto;
  box-sizing: border-box;
  right: auto;
}

/* Logo */
.app-logo {
  max-width: 280px;
  width: 85%;
  height: auto;
  display: block;
  margin: 0 auto;
  filter: drop-shadow(0 6px 16px rgba(0,0,0,0.15));
}

/* Broom animacija */
.broom-anim {
  position: absolute;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  font-size: 24px;
  pointer-events: none;
  z-index: 10;
  animation: broomSweep 0.8s ease-out forwards;
}

@keyframes broomSweep {
  0% {
    transform: translateY(-50%) translateX(0) rotate(-15deg);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-50%) translateX(var(--broom-end)) rotate(10deg);
    opacity: 0;
  }
}


#container {
  margin: 0;
  padding: 0;
  list-style: none;
}

#container > li.floor {
  margin: 12px 0 0 0 !important;
  padding: 0 !important;
  width: 100% !important;
}


#container .group {
  margin: 8px 0 8px 28px !important;
  width: calc(100% - 28px) !important;
  padding: 0 !important;
}


#container .item {
  margin: 6px 0 6px 28px !important;
  padding: 0 !important;
  width: calc(100% - 28px) !important;
}


.group > div,
.item > div {
  padding: 12px 16px !important;
}


.group > div {
  background: #f8fbff !important;
  border-radius: 12px !important;
}

.item > div {
  background: #ffffff !important;
  border-radius: 10px !important;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
}

</style>
</head>
<body>

<!-- TOP BAR: INSTALL BUTTON LEFT, VERSION BADGE RIGHT -->
<div class="topBar">
  <button id="installBtn">Install</button>
  <div id="appVersion">v</div>
</div>

<div id="installAlert" class="version-tooltip" style="display:none">
  <p><strong>To install DeepSweep:</strong></p>
  <ul>
    <li><strong>Android:</strong> Open browser menu â†’ Add to Home screen</li>
    <li><strong>iOS:</strong> Tap Share â†’ Add to Home Screen</li>
  </ul>
</div>

<div class="app-title">
  <img src="logo.png" alt="DeepSweep" class="app-logo">
</div>
<p id="counter">Total Trash: 0 | Found: 0</p>

<!-- Find Unfound + Location Filter -->
<button id="openUncheckedBtn">Missing Items</button>
<select id="locationFilter">
  <option value="-all-">-all-</option>
</select>

<ul id="container"></ul>

<script>
// --- PWA install logic ---
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
function hideInstall(){ installBtn.style.display='none'; installAlert.style.display='none'; }
if(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone===true){ hideInstall(); }
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.style.display='block'; });
installBtn.addEventListener('touchend', (e) => {
  e.preventDefault();
});

// --- INSTALL BUTTON + ALERT ---

const installAlert = document.getElementById('installAlert');
let installTooltipVisible = false;

function showInstallTooltip() {
  if (installAlert.style.display === 'block') return;

  installAlert.style.display = 'block';
  installAlert.style.opacity = '0';
  installAlert.style.transform = 'translateY(-6px)';

  const rect = installBtn.getBoundingClientRect();
  
  installAlert.style.top = (rect.bottom + window.scrollY + 8) + 'px';

  let left = rect.left + window.scrollX;
  const padding = 12;
  const tooltipWidth = installAlert.offsetWidth;

  if (left + tooltipWidth > window.innerWidth - padding) {
    left = window.innerWidth - tooltipWidth - padding;
  }
  if (left < padding) {
    left = padding;
  }

  installAlert.style.left = left + 'px';
  installAlert.style.right = 'auto';

  requestAnimationFrame(() => {
    installAlert.style.opacity = '1';
    installAlert.style.transform = 'translateY(0)';
  });

  installTooltipVisible = true;
}

function hideInstallTooltip() {
  if (!installTooltipVisible) return;
  installAlert.style.opacity = '0';
  installAlert.style.transform = 'translateY(-6px)';
  setTimeout(() => {
    installAlert.style.display = 'none';
    installTooltipVisible = false;
  }, 180);
}

function toggleInstallTooltip(e) {
  e.preventDefault();
  e.stopPropagation();

  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(({ outcome }) => {
      deferredPrompt = null;
      if (outcome === 'accepted') {
        hideInstall();
      }
      hideInstallTooltip();
    });
    return;
  }

  if (installTooltipVisible) {
    hideInstallTooltip();
  } else {
    showInstallTooltip();
  }
}

const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

if (isTouch) {
  installBtn.addEventListener('touchend', toggleInstallTooltip);
} else {
  installBtn.addEventListener('click', toggleInstallTooltip);
}

function closeIfOutside(e) {
  if (!installTooltipVisible) return;
  if (installBtn.contains(e.target) || installAlert.contains(e.target)) return;
  hideInstallTooltip();
}

document.addEventListener(isTouch ? 'touchend' : 'click', closeIfOutside);

installAlert.addEventListener(isTouch ? 'touchend' : 'click', e => e.stopPropagation());

document.addEventListener('click', (e) => {
  if (installAlert.style.display === 'block' &&
      !installBtn.contains(e.target) &&
      !installAlert.contains(e.target)) {
    installAlert.style.display = 'none';
  }
});
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').then(()=>console.log('Service Worker registered')).catch(err=>console.log('SW registration failed', err)); }

// --- LocalStorage helpers ---
function loadState(){ return JSON.parse(localStorage.getItem('deepsweepState')||'{}'); }
function saveState(state){ localStorage.setItem('deepsweepState', JSON.stringify(state)); }

// --- Counter ---
function updateCounter() {
  const allItems = document.querySelectorAll('li.item input[type=checkbox]');
  const checkedItems = Array.from(allItems).filter(cb=>cb.checked).length;
  document.getElementById('counter').textContent = `Found Trash: ${checkedItems} / ${allItems.length}`;
}

// --- Load JSON and build UI ---
let state = loadState();

fetch('data.json')
  .then(res => res.json())
  .then(data => {
    buildUI(data);
    syncGroupAndFloorCheckboxes();
    updateCounter();

    // Manual order
    const desiredOrder = [
      "-all-",
      "Paradise Island",
      "Great Lakes",
      "Costa Rica",
      "Alaska",
      "Australia",
      "Scotland",
      "Thailand",
      "Amazon",
	  "Marina",
	  "Chemical Plant"
    ];

    const locationFilter = document.getElementById('locationFilter');
    locationFilter.innerHTML = ''; // oÄisti stare opcije

    const existingLocations = new Set(
      data.map(item => item.locationName).filter(Boolean)
    );

    desiredOrder.forEach(loc => {
      if (loc === "-all-" || existingLocations.has(loc)) {
        const opt = document.createElement('option');
        opt.value = loc;
        opt.textContent = loc;
        locationFilter.appendChild(opt);
      }
    });
  })
  .catch(err => {
    console.error("Failed to load data.json", err);
  });
  
  
    // --- Populate Location Dropdown ---
   //const locationFilter = document.getElementById('locationFilter');
    //const locationsSet = new Set();
    //data.forEach(item=>{ if(item.locationName) locationsSet.add(item.locationName); });
    //locationsSet.forEach(loc=>{
      //const opt = document.createElement('option');
      //opt.value = loc;
      //opt.textContent = loc;
      //locationFilter.appendChild(opt);
   //});



function buildUI(data){
  const floors = {};
  data.forEach(item=>{
    if(!floors[item.floor]) floors[item.floor]={};
    if(!floors[item.floor][item.group]) floors[item.floor][item.group]=[];
    floors[item.floor][item.group].push(item);
  });

  const container = document.getElementById('container');

  function createItem(item, groupCheckbox, floorCheckbox){
  const li = document.createElement('li'); 
  li.className = 'item';

  const wrapper = document.createElement('div');

  const id = `${item.floor}_${item.group}_${item.name}`.replace(/\s/g,'_');

  const cb = document.createElement('input'); 
  cb.type = 'checkbox'; 
  cb.id = id; 
  cb.dataset.id = id;
  if(state[id]!==undefined) cb.checked = state[id];

  cb.addEventListener('change', ()=>{
    if (navigator.vibrate) navigator.vibrate(15);
    state[id] = cb.checked;
    updateGroupAndFloor(groupCheckbox, floorCheckbox);
    saveState(state);
    updateCounter();
  });

  const img = document.createElement('img'); 
  img.src = item.img; 
  img.alt = item.name;
  img.addEventListener('click', ()=>{ 
    cb.checked = !cb.checked; 
    cb.dispatchEvent(new Event('change')); 
  });

  const label = document.createElement('label'); 
  label.setAttribute('for', id); 
  label.textContent = item.name;
  label.title = item.name; // za tooltip na mobitelu

  // Novi div za prvi red: checkbox + slika
  const firstRow = document.createElement('div');
  firstRow.className = 'first-row';
  firstRow.appendChild(cb);
  firstRow.appendChild(img);

  wrapper.appendChild(firstRow);
  wrapper.appendChild(label);

  if(item.locationName && item.locationLink){
    const locBtn = document.createElement('a');
    locBtn.textContent = item.locationName;
    locBtn.href = item.locationLink;
    locBtn.target = '_blank';
    locBtn.className = 'locationBtn';
    wrapper.appendChild(locBtn);
  }

  li.appendChild(wrapper);
  return li;
}

  function createGroup(groupName, items, floorCheckbox){
    const li=document.createElement('li'); li.className='group';
    const wrapper=document.createElement('div');
    const toggle=document.createElement('span'); toggle.textContent='â–¶'; toggle.className='toggle';
    const id=`group_${groupName}`.replace(/\s/g,'_');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.id=id;
    if(state[id]!==undefined) cb.checked=state[id];

    cb.addEventListener('change', ()=>{
        const checked = cb.checked;
        li.querySelectorAll('li.item input[type=checkbox]').forEach(i=>{
            i.checked = checked;
            if(i.dataset.id) state[i.dataset.id] = i.checked;
        });
        state[id] = checked;
        saveState(state);
        updateGroupAndFloor(cb, floorCheckbox);
        updateCounter();
    });

    const label=document.createElement('span'); label.textContent=groupName;
    const itemsList=document.createElement('ul');
    items.forEach(item=>itemsList.appendChild(createItem(item, cb, floorCheckbox)));
    itemsList.style.display='none';

    toggle.addEventListener('click', ()=>{ 
        itemsList.style.display = itemsList.style.display==='none'?'block':'none'; 
        toggle.textContent = itemsList.style.display==='none'?'â–¶':'â–¼'; 
    });
    label.addEventListener('click', ()=>toggle.click());

    wrapper.appendChild(toggle); wrapper.appendChild(cb); wrapper.appendChild(label);
    li.appendChild(wrapper);
    li.appendChild(itemsList);
    return li;
  }

  function createFloor(floorName, groups){
    const li=document.createElement('li'); li.className='floor';
    const wrapper=document.createElement('div');
    const toggle=document.createElement('span'); toggle.textContent='â–¶'; toggle.className='toggle';
    const id=`floor_${floorName}`.replace(/\s/g,'_');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.id=id;
    if(state[id]!==undefined) cb.checked=state[id];

    cb.addEventListener('change', ()=>{
        const checked = cb.checked;
        li.querySelectorAll('li.group > div > input[type=checkbox], li.item input[type=checkbox]').forEach(i=>{
            i.checked = checked;
            if(i.dataset.id) state[i.dataset.id] = i.checked;
        });
        state[id] = checked;
        saveState(state);
        updateCounter();
    });

    const label=document.createElement('span'); label.textContent=floorName;
    const groupsList=document.createElement('ul');
    for(const groupName in groups) groupsList.appendChild(createGroup(groupName, groups[groupName], cb));
    groupsList.style.display='none';

    toggle.addEventListener('click', ()=>{ 
        groupsList.style.display = groupsList.style.display==='none'?'block':'none'; 
        toggle.textContent = groupsList.style.display==='none'?'â–¶':'â–¼'; 
    });
    label.addEventListener('click', ()=>toggle.click());

    wrapper.appendChild(toggle); wrapper.appendChild(cb); wrapper.appendChild(label);
    li.appendChild(wrapper);
    li.appendChild(groupsList);
    container.appendChild(li);
  }

  for(const floorName in floors) createFloor(floorName,floors[floorName]);

  function updateGroupAndFloor(groupCheckbox, floorCheckbox){
  const groupLi = groupCheckbox.closest('li.group');
  const items = groupLi.querySelectorAll('li.item input[type=checkbox]');
  const allChecked = Array.from(items).every(i=>i.checked);

  groupCheckbox.checked = allChecked;

if (allChecked) {
  // group animation
  playBroomAnimation(groupLi);

  // haptic feedback
  if (navigator.vibrate) {
    navigator.vibrate([20, 30, 20]);
  }
}
function playBroomAnimation(groupLi) {
  const wrapper = groupLi.querySelector('div');
  const checkbox = wrapper.querySelector('input[type="checkbox"]');
  const label = wrapper.querySelector('span');

  if (!wrapper || !checkbox || !label) return;

  const broom = document.createElement('span');
  broom.textContent = 'ðŸ§¹';
  broom.className = 'broom-anim';

  wrapper.style.position = 'relative';
  wrapper.appendChild(broom);

  // group start = checkbox
  const startX = checkbox.offsetLeft;
  const endX = label.offsetLeft + label.offsetWidth;

  broom.style.left = startX + 'px';
  broom.style.setProperty('--broom-end', endX + 'px');

  broom.addEventListener('animationend', () => {
    broom.remove();
  });
}

  // floor logic
  const groups = floorCheckbox
    .closest('li.floor')
    .querySelectorAll('li.group > div > input[type=checkbox]');

  floorCheckbox.checked = Array.from(groups).every(g=>g.checked);
}
}
function syncGroupAndFloorCheckboxes() {
  // GROUPS
  document.querySelectorAll('li.group').forEach(groupLi => {
    const groupCheckbox = groupLi.querySelector('div > input[type=checkbox]');
    const items = groupLi.querySelectorAll('li.item input[type=checkbox]');
    if (!groupCheckbox || items.length === 0) return;

    groupCheckbox.checked = Array.from(items).every(cb => cb.checked);
  });

  // FLOORS
  document.querySelectorAll('li.floor').forEach(floorLi => {
    const floorCheckbox = floorLi.querySelector('div > input[type=checkbox]');
    const groupCheckboxes = floorLi.querySelectorAll('li.group > div > input[type=checkbox]');
    if (!floorCheckbox || groupCheckboxes.length === 0) return;

    floorCheckbox.checked = Array.from(groupCheckboxes).every(cb => cb.checked);
  });
}

// --- Find Unfound with Location Filter (Toggle Behavior) ---
let missingOpen = false; // prati je li trenutno otvoreno
function runMissingItemsFilter() {
  const filter = document.getElementById('locationFilter').value;

  if (missingOpen) {
    document.querySelectorAll('li.floor').forEach(floorLi => {
      const groupsList = floorLi.querySelector('ul');
      if (groupsList) groupsList.style.display = 'none';

      const floorToggle = floorLi.querySelector('.toggle');
      if (floorToggle) floorToggle.textContent = 'â–¶';

      floorLi.querySelectorAll('li.group').forEach(groupLi => {
        const ul = groupLi.querySelector('ul');
        const toggle = groupLi.querySelector('.toggle');
        if (ul) ul.style.display = 'none';
        if (toggle) toggle.textContent = 'â–¶';

        groupLi.querySelectorAll('li.item').forEach(itemLi => {
          itemLi.style.display = '';
        });
      });
    });

    missingOpen = false;
    return;
  }

  document.querySelectorAll('li.floor').forEach(floorLi => {
    let floorHasUnchecked = false;

    floorLi.querySelectorAll('li.group').forEach(groupLi => {
      let groupHasUnchecked = false;

      groupLi.querySelectorAll('li.item').forEach(itemLi => {
        const cb = itemLi.querySelector('input[type=checkbox]');
        const locBtn = itemLi.querySelector('.locationBtn');
        const locName = locBtn ? locBtn.textContent : null;

        const matchesLocation =
          filter === '-all-' || filter === locName;

        if (!matchesLocation || cb.checked) {
          itemLi.style.display = 'none';
          return;
        }

        itemLi.style.display = '';
        groupHasUnchecked = true;
      });

      const ul = groupLi.querySelector('ul');
      const toggle = groupLi.querySelector('.toggle');

      if (groupHasUnchecked) {
        ul.style.display = 'block';
        toggle.textContent = 'â–¼';
        floorHasUnchecked = true;
      } else {
        ul.style.display = 'none';
        toggle.textContent = 'â–¶';
      }
    });

    const floorUl = floorLi.querySelector('ul');
    const floorToggle = floorLi.querySelector('.toggle');

    if (floorHasUnchecked) {
      floorUl.style.display = 'block';
      floorToggle.textContent = 'â–¼';
    } else {
      floorUl.style.display = 'none';
      floorToggle.textContent = 'â–¶';
    }
  });

  missingOpen = true;
}

function refreshMissingItemsFilter() {
  if (!missingOpen) return;

  // privremeno ugasi flag
  missingOpen = false;
  runMissingItemsFilter();
}

document
  .getElementById('openUncheckedBtn')
  .addEventListener('click', runMissingItemsFilter);

document
  .getElementById('locationFilter')
  .addEventListener('change', refreshMissingItemsFilter);



// ================= VERSION BADGE TOOLTIP =================
fetch('version.json')
  .then(res => res.json())
  .then(v => {
    const badge = document.getElementById('appVersion');
    if (!badge) return;

    const currentVersion = v.current;
    const changes = v.changes?.[currentVersion] || [];

    badge.textContent = 'v' + currentVersion;

    // red dot
    if (localStorage.getItem('deepsweep_seenVersion') !== currentVersion) {
      const dot = document.createElement('span');
      Object.assign(dot.style, {
        display: 'inline-block',
        width: '8px',
        height: '8px',
        background: 'red',
        borderRadius: '50%',
        marginLeft: '6px',
        verticalAlign: 'middle'
      });
      badge.appendChild(dot);
    }

    let tooltip = null;

    const closeTooltip = () => {
      if (!tooltip) return;
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(-6px)';
      setTimeout(() => {
        tooltip?.remove();
        tooltip = null;
      }, 160);
    };

    const toggleTooltip = (e) => {
      e.stopPropagation();
      if (!changes.length) return;

      if (tooltip) {
        closeTooltip();
        return;
      }

      tooltip = document.createElement('div');
      tooltip.className = 'version-tooltip';
      tooltip.innerHTML = `
        <strong>What's new</strong>
        <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
      `;

      document.body.appendChild(tooltip);

      const rect = badge.getBoundingClientRect();
	  tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';

      let left = rect.left + window.scrollX;
      const tooltipWidth = tooltip.offsetWidth;
const badgeRight = rect.right + window.scrollX;
if (left + tooltipWidth > badgeRight) {
  left = badgeRight - tooltipWidth;  // desna strana tooltipa = desna strana badgea
}

if (left < 8) left = 8;
if (left + tooltipWidth > window.innerWidth - 8) {
  left = window.innerWidth - tooltipWidth - 8;
}

tooltip.style.left = left + 'px';

      requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'translateY(0)';
      });

      localStorage.setItem('deepsweep_seenVersion', currentVersion);
      badge.querySelector('span')?.remove();
    };

badge.addEventListener('click', toggleTooltip);

if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
  badge.addEventListener('touchend', (e) => {
    e.preventDefault();
    toggleTooltip(e);
  });
}

    document.addEventListener('click', (e) => {
      if (tooltip && !badge.contains(e.target) && !tooltip.contains(e.target)) {
        closeTooltip();
      }
    });
  })
  .catch(err => console.error('Failed to load version.json', err));

function playBroomAnimation(groupLi) {
  const wrapper = groupLi.querySelector('div');
  if (!wrapper) return;

  if (wrapper.querySelector('.broom-sweep')) return;

  const broom = document.createElement('span');
  broom.className = 'broom-sweep';
  broom.textContent = 'ðŸ§¹';

  wrapper.appendChild(broom);

  broom.addEventListener('animationend', () => {
    broom.remove();
  });
}
</script>
</body>
</html>
